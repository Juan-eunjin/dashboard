<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.dashboard.mapper.JiraMapper">

    <!-- 1.이슈 저장 -->
    <insert id="insert" parameterType="com.example.dashboard.domain.JiraIssue">
        INSERT INTO issuetable (issuekey, labels, title, status, assingee, issuedate, duedate)
        VALUES (#{issueKey}, #{labels}, #{title}, #{status}, #{assignee}, #{issueDate}, #{dueDate}) ON DUPLICATE KEY
        UPDATE
            labels =
        VALUES (labels), title =
        VALUES (title), status =
        VALUES (status), assingee =
        VALUES (assingee), issuedate =
        VALUES (issuedate), duedate =
        VALUES (duedate)
    </insert>

    <!-- 2. 메인 대시보드 통계 조회 -->
    <select id="getIssueSummary" resultType="com.example.dashboard.dto.IssueSummaryDto">
        SELECT
        COUNT(*) AS totalIssues,
        /* 1. 진행 중 상태 집계 */
        SUM(CASE WHEN status IN ('In Progress', '진행 중') THEN 1 ELSE 0 END) AS inProgress,

        /* 2. 완료 상태 집계 */
        SUM(CASE WHEN status IN ('Done', '완료') THEN 1 ELSE 0 END) AS done,

        /* 3. 진행 전(Open) 상태 집계 */
        SUM(CASE WHEN status IN ('Open', '할 일', 'To Do', '해야 할 일') THEN 1 ELSE 0 END) AS open,

        /* 4. Overdue(지연): 완료되지 않았고 마감 기한이 오늘보다 이전인 경우 */
        SUM(CASE WHEN status NOT IN ('Done', '완료')
        AND duedate IS NOT NULL
        AND duedate &lt; CURDATE() THEN 1 ELSE 0 END) AS overdue
        FROM issuetable
        <where>
            <if test="labels != null and labels != ''">
                AND labels = #{labels}
            </if>
            <if test="startDate != null and startDate != ''">
                AND issuedate &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND issuedate &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 3. 일일 이슈 발생 내역 조회 -->
    <select id="getDailyIssues" resultType="com.example.dashboard.dto.DailyIssueResponse">
        SELECT
        DATE(i.issuedate) AS issueDate,
        #{labels} AS labels,
        COUNT(DISTINCT i.issueKey) AS totalIssues
        FROM
        issuetable i
        <where>
            <if test="labels != null and labels != ''">
                AND i.labels LIKE CONCAT('%', #{labels}, '%')
            </if>
            <if test="startDate != null and endDate != null">
                AND i.issuedate BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
        GROUP BY
        DATE(i.issuedate)
        ORDER BY
        issueDate ASC
    </select>

    <!-- 4.프로젝트 목록 조회 -->
    <select id="getProjectList" resultType="string">
        SELECT DISTINCT labels
        FROM issuetable
        WHERE labels IS NOT NULL
          AND labels != ''
        ORDER BY labels ASC
    </select>

    <!-- 5. 상세 페이지 용 이슈 리스트 조회 -->
    <select id="getIssuesList" resultType="com.example.dashboard.dto.IssueListResponse">
        SELECT
        issuekey,
        title AS summary,
        issuedate,
        assingee,
        status,
        duedate,
        labels
        FROM issuetable
        <where>
            <if test="labels != null and labels != ''">
                AND labels LIKE CONCAT('%', #{labels}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                AND issuedate BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
        ORDER BY issuedate DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
</mapper>